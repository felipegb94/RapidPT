<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Rapidpt by felipegb94</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Rapidpt</h1>
      <h2 class="project-tagline">Rapid Permutation Testing using Matrix Completion Methods</h2>
      <a href="https://github.com/felipegb94/RapidPT" class="btn">View on GitHub</a>
      <a href="https://github.com/felipegb94/RapidPT/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/felipegb94/RapidPT/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="rapidpt" class="anchor" href="#rapidpt" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RapidPT</h1>

<h2>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Table of Contents</h2>

<ol>
<li><a href="#overview">Overview</a></li>
<li><a href="#usecases">Use Cases</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#usage">Usage</a></li>
<li>
<a href="#usagesnpm">Usage within SnPM</a>

<ul>
<li><a href="#snpmprerequisites">Prerequisites</a></li>
<li><a href="#snpmrapidptsetup">SnPM + RapidPT Setup</a></li>
<li><a href="#snpmusage">Usage</a></li>
<li><a href="#snpmoutputs">Outputs Info</a></li>
<li><a href="#snpmnotes">Important Notes</a></li>
</ul>
</li>
<li><a href="#codeorganization">Code Organization</a></li>
<li><a href="#warnings">Warnings</a></li>
<li><a href="#references">References</a></li>
</ol>

<p><a name="overview"></a></p>

<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>

<p></p>

<p>Multiple hypothesis testing is a problem when applying statistical tests on neuroimaging studies. Permutation testing is a nonparametric method for estimating an alpha threshold that can accurately help identify what brain regions display statistically significant differences or activity. The computational burden of this method, however, for low thresholds and large datasets can be prohibitive.</p>

<p><strong>RapidPT</strong> is a MATLAB toolbox for fast, reliable, hardware independent, permutation testing. </p>

<p><strong>1. Fast:</strong> RapidPT has shown speedups ranging from <strong>30-90x</strong> faster than simple permutation testing implementations, and <strong>3-6x</strong> faster than SnPM, a state of the art permutation testing toolbox for neuroimaging data. The larger speedups are seen when the number of permutations being done exceeds 10,000, and the size of the dataset is larger than 20 subjects.</p>

<p><img src="http://felipegb94.github.io/RapidPT/images/FirstSetNaivePT_Speedups_80000.png" alt="SpeedupNaivePT">
<img src="http://felipegb94.github.io/RapidPT/images/FirstSet_Speedups_160000.png" alt="SpeedupSnPM"></p>

<p><strong>2. Reliable:</strong> RapidPT has been validated against SnPM and a personal permutation testing implementation. The validation was done by comparing the KL-Divergence and p-values of the maximum-null distribution recovered by each software. More than <strong>200 validation runs</strong> have been done with various neuroimaging datasets composed from 10 up to 400 subjects. </p>

<p><strong>3. Hardware Independent:</strong> It has been shown that with powerful enough hardware (highend GPUs or a cluster) and an efficient implementation, the permutation testing procedure can be spedup by many orders of magnitude. These implementations highly rely on expensive hardware. RapidPT, however, takes advantage of the structure of the problem to speedup the algorithm, allowing it to be efficient even in regular laptops.</p>

<p><a name="usecases"></a></p>

<h2>
<a id="use-cases" class="anchor" href="#use-cases" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Use cases</h2>

<p>
RapidPT can be used for the nonparametric statistical analysis of neuroimaging data. The permutation testing procedure modeled by RapidPT is a nonparametric combination of two-sample t-test. Two sample t-test are typically used to determine if two population means are equal. Various use cases in neuroimaging and similar applications show up here such as:</p>

<p><strong>1. Placebo-Control Clinical Trials:</strong> Detect statistically significant difference between the brain images of the subjects assigned to the placebo and control groups.</p>

<p><strong>2. Activation Studies:</strong> Detect statistically significant differences between the brain images of subjects during activation vs. during rest.</p>

<p><strong>Note to users:</strong> Feel free to add more use cases.</p>

<p><a name="setup"></a></p>

<h2>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup</h2>

<p>
Simply clone the repository and add the path of the repository inside your program to be able to call the functions.</p>

<pre><code>addpath('PATH_WHERE_YOU_CLONED_THE_REPOSITORY');
%% YOUR MATLAB PROGRAM GOES HERE. 
</code></pre>

<p>If you don't want to have the <code>addpath</code> line in every program you make, you can have it in your <code>startup.m</code> file for you MATLAB setup.</p>

<p><a name="usage"></a></p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>
There are two ways to use the core of RapidPT, either by calling the wrapper function <code>TwoSampleRapidPT.m</code> or directly calling the core function <code>RapidPT.m</code>. <code>TwoSampleRapidPT</code> assigns some default inputs that have been extensively tested that produce an accurate recovery of the maxnull distribution and then calls <code>RapidPT</code>. On the other hand if you call <code>RapidPT</code> directly you will have to assign these parameters. Let's first go through <code>Example_TwoSampleRapidPT.m</code>:</p>

<h4>
<a id="example_twosamplerapidptm" class="anchor" href="#example_twosamplerapidptm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>Example_TwoSampleRapidPT.m</code>
</h4>

<ol>
<li>
<p>First add the path to where you cloned/downloaded the <code>RapidPT</code> repository, and also load the data you will be working with. The data matrix needs to be an <code>NxV</code>, where <code>N</code> is the total number of subjects and V is the number of voxel statistics per subject.</p>

<pre><code>RapidPTLibraryPath = '.';
addpath(RapidPTLibraryPath);
dataPath = 'PATH TO DATA'; 
load(dataPath);
</code></pre>
</li>
<li>
<p>Set number of permutations and the number of subjects in either group 1 or 2 (it does not matter which one you specify).</p>

<pre><code>numPermutations = 5000;
nGroup1 = 25; % You should what is the size of one of your groups prior.
</code></pre>
</li>
<li><p>Set <code>write</code>. If set to 0, outputs will only contain the constructed maximum null distribution. If set to 1, the outputs struct will contain the basis matrix, <code>U</code>, and coefficient matrix <code>W</code>. <code>U*W</code> recover the permutation matrix. For an in depth explanation see the references. </p></li>
<li>
<p>Call <code>TwoSampleRapidPT.m</code>. <code>outputs</code> is a struct containing <code>outputs.MaxT</code>,<code>outputs.U</code>, and <code>outputs.W</code>. <code>timings</code> is a struct containing timing information of different part of <code>RapidPT</code> as well as the total timing.</p>

<pre><code>[outputs, timings] = TwoSampleRapidPT(Data, numPermutations, nGroup1, write, RapidPTLibraryPath);
</code></pre>
</li>
<li><p>Optionally save <code>outputs</code> and <code>timings</code>.</p></li>
<li>
<p>Get the t-threshold estimate from the recovered maximum null distribution.</p>

<pre><code>alpha_threshold = 1; % 1 percent
t_threshold = GetTThresh(outputs.MaxT, alpha_threshold);
</code></pre>
</li>
<li><p>If you have the labels of the data available, you can calculate the two-sample t-test and see compare the result of each voxel to the t-threshold and see which voxels exhibit statistically significant activity.</p></li>
</ol>

<h4>
<a id="example_rapidptm" class="anchor" href="#example_rapidptm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>Example_RapidPT.m</code>
</h4>

<p>Take a look at the header comments of <code>RapidPT.m</code> and the comments in <code>Example_RapidPT.m</code> to see how to directly call <code>RapidPT.m</code>. It is recommended to use <code>TwoSampleRapidPT.m</code> in order to avoid hyperparameter tuning.</p>

<p><a name="usagesnpm"></a></p>

<h2>
<a id="usage-within-snpm" class="anchor" href="#usage-within-snpm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage within SnPM</h2>

<p>
<a name="snpmprerequisites"></a></p>

<h3>
<a id="prerequistes" class="anchor" href="#prerequistes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Prerequistes</h3>

<p></p>

<ul>
<li>
<a href="http://www.fil.ion.ucl.ac.uk/spm/software/">SPM12</a> - In order to be able to use RapidPT within SPM/SnPM you will need to have SPM12 setup (obviously). </li>
<li>
<a href="http://www.mathworks.com/matlabcentral/fileexchange/8797-tools-for-nifti-and-analyze-image">NiFTI</a> - You will also need the NiFTI toolset. Make sure the NiFTI toolset path is added before you run SnPM.</li>
<li>Git (recommended) - The setup below uses git to clone the repositories. Instead of cloning them you can also download the zip files from the links given throughout the setup instructions.</li>
</ul>

<p><a name="snpmrapidptsetup"></a></p>

<h3>
<a id="snpm--rapidpt-setup" class="anchor" href="#snpm--rapidpt-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SnPM + RapidPT Setup</h3>

<p>
Currently to use RapidPT within SnPM you will have to <a href="https://github.com/felipegb94/SnPM-devel">download my fork of SnPM</a> (personal copy of SnPM). To do this, go to wherever your SPM installation/folder is (mine is under my MATLAB folder) and do the following commands:</p>

<pre><code>cd WHEREVER YOUR SPM DOWNLOAD IS
cd spm12/toolbox/
git clone https://github.com/felipegb94/SnPM-devel.git
cd SnPM-devel/
</code></pre>

<p>Then we have to make a quick change to <code>snpm_cp.m</code> in order to be able to use RapidPT. In line <code>781</code> you will have to change </p>

<pre><code>RapidPT_path = ~/PermTest/RapidPT/
</code></pre>

<p>to the path where you downloaded <code>RapidPT</code>. For example, you can do the following</p>

<pre><code>cd ~/
git clone https://github.com/felipegb94/RapidPT.git
</code></pre>

<p>Here we just downloaded RapidPT to you home folder, and then go into <code>snpm_cp.m</code> and change the <code>RapidPT_path</code> variable:</p>

<pre><code>RapidPT_path = ~/RapidPT/
</code></pre>

<p>Save <code>snpm_cp.m</code> and, now in the MATLAB command line you can launch SPM and use RapidPT.</p>

<p><a name="snpmusage"></a></p>

<h3>
<a id="snpm-usage" class="anchor" href="#snpm-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SnPM Usage</h3>

<p></p>

<p>This would be a good time to read the important notes below. </p>

<p>Now that you have setup RapidPT within SnPM, SnPM will work very similar to before. Launch SPM,</p>

<pre><code>spm fmri
</code></pre>

<p>Now follow these steps:</p>

<ol>
<li>Go to SPM Menu window.</li>
<li>Click on Batch and go to the batch window that just opened.</li>
<li>On the navigation bar click on SPM, then <code>tools/SnPM/Specify/2 Groups Two Sample T test; 1 scan per subject</code>.</li>
<li>Here you will be able to specifiy a folder where you want your outputs to be (<code>Analysis Directory</code>), your input data (.nii images of group1 and group2), and also the number of permutations you want to do. </li>
<li>Click the green run button. This creates an SnPM config file in the path where you want your outputs to be. This step should take a few seconds only.</li>
<li>Go to SPM navigation bar again, then <code>Tools/SnPM/Compute</code>
</li>
<li>Set the SnPM cfg file to the one you just made by clicking on the run button. </li>
<li>Click the green run button again, and now SnPM will run with RapidPT.</li>
<li>Once you are done, go to the directory that you selected as your <code>Analysis Directory</code> and look at the outputs.</li>
</ol>

<p><a name="snpmoutputs"></a></p>

<h3>
<a id="outputs" class="anchor" href="#outputs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Outputs</h3>

<p>
Once you are done, inside your <code>analysis</code> directory you will find a folder called <code>outputs</code>. This folder contains the results from RapidPT:</p>

<ul>
<li> <code>MaxT.mat</code>: This is the recovered maximum null distribution.</li>
<li> <code>SnPMt.mat</code>: This is the resulting test statistic calculated using the original labels of the data. </li>
<li> <code>XYZ.mat</code>: This matrix has the x, y, z coordinates associated to each voxel.</li>
<li> <code>params.mat</code>: This structure contains the following parameters of the permutation testing run: nPerm (number of permutations), N (number of subjects), V (number of voxels after preprocessing), xdim, ydim, zdim.</li>
<li> <code>coords_activeBrain_0.05.mat</code>: This contains the x,y,z coordinates of the voxels that were found to be displaying significant group differences with a significance level of alpha = 0.05.</li>
<li> <code>activeBrain_0.05.nii</code>: This is a binary brain nii file. The 1's are the voxels that were found to display significant group differences. </li>
<li> <code>timings.mat</code>: Contains some timing from rapidpt. </li>
</ul>

<p><a name="snpmnotes"></a></p>

<h3>
<a id="improtant-notes-please-read-before-using" class="anchor" href="#improtant-notes-please-read-before-using" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Improtant Notes (PLEASE READ BEFORE USING):</h3>

<p></p>

<ul>
<li><p>RapidPT is only available for TwoSample t-test right now because it is the procedure that has been extensively validated and benchmarked. Regular SnPM should run if you try running SnPM with any other tests.</p></li>
<li><p>I integrated RapidPT into SnPM for users to be able to take advantages of SPM/SnPM graphical user interface and pre-processing. If you run SnPM with RapitPT, however, you will not be able to take advantage of any of SnPM/SPM postprocessing features because RapidPT when doing the permutation tests does not generate all of the required data for SnPM to use. If RapidPT is fully integrated into SnPM, then we will make sure that the post-processing capabilities of SnPM are also available.</p></li>
</ul>

<p><a name="codeorganization"></a></p>

<h2>
<a id="code-organization" class="anchor" href="#code-organization" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Code Organization</h2>

<p></p>

<h3>
<a id="rapidpt-1" class="anchor" href="#rapidpt-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RapidPT</h3>

<h4>
<a id="rapidptm" class="anchor" href="#rapidptm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>RapidPT.m</code>
</h4>

<p>This is the core of RapidPT. This is where the main algorithm and math ideas described in the NIPS paper happen.</p>

<h4>
<a id="twosamplerapidptm" class="anchor" href="#twosamplerapidptm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>TwoSampleRapidPT.m</code>
</h4>

<p>This is a wrapper of the core. This function will assign most of the hyperparameters that can be given to <code>RapidPT.m</code> for you. The hyperparameters chosen have been extensively tested, and some of them are derived from the data dimensions and number of permutations chosen.</p>

<h4>
<a id="example_twosamplerapidptm-1" class="anchor" href="#example_twosamplerapidptm-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>Example_TwoSampleRapidPT.m</code>
</h4>

<p>This is an example script that uses <code>TwoSampleRapidPT.m</code> wrapper program.</p>

<h4>
<a id="example_rapidptm-1" class="anchor" href="#example_rapidptm-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>Example_RapidPT.m</code>
</h4>

<p>This is an example script that directly uses <code>RapidPT.m</code>. You will note that a lot more hyperparameters need to be passed to <code>RapidPT.m</code> compared to <code>TwoSampleRapidPT.m</code>.</p>

<h4>
<a id="twosamplegetlabelsmatricesm" class="anchor" href="#twosamplegetlabelsmatricesm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>TwoSampleGetLabelsMatrices.m</code>
</h4>

<p>This is a function that given: <code>numPermutations</code> (Number of Permutations to be done), <code>N</code> (total number of subjects), <code>nGroup1</code> (The number of subjects in group1), returns the labels for each subject in each group that will be used at each permutation. </p>

<h3>
<a id="include" class="anchor" href="#include" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>include/</h3>

<p>The <code>include/</code> folder contains the library <em>grasta</em>. This library contains the online matrix completion method we use to accelerate permutation testing. For more information about <em>grasta</em> you can refer to the <a href="https://sites.google.com/site/hejunzz/grasta#TOC-Robust-Matrix-Completion">project website</a>.</p>

<h3>
<a id="outputs--timings" class="anchor" href="#outputs--timings" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>outputs/ &amp; timings/</h3>

<p>These are the default directories used to output the resulting max-null distribution, and timings of different sections of the algorithm. If the flag <code>inputs.write</code> is set to <code>1</code> the low-rank basis, <code>U</code>, and the coefficient matrix, <code>W</code>, that can recover the permutation matrix will also be saved.</p>

<h3>
<a id="util" class="anchor" href="#util" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>util/</h3>

<p>This directory contains various utility functions used by RapidPT for input validation and post-processing. Separating these functions from the main code makes <code>TwoSampleRapidPT.m</code> more concise.</p>

<p><a name="warnings"></a></p>

<h2>
<a id="warnings" class="anchor" href="#warnings" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Warnings</h2>

<p>
RapidPT has been extensively tested on medium and large datasets (20+ subjects) of a specific flavor. The datasets have been composed of group1 and group2 type data. Additionally these datasets after preprocessing give 300,000+ voxel statistics. Hence speedups/accuracy seen here have been on these types of datasets, and it might not make sense to use RapidPT on smaller datasets since the permutation testing procedure would take only a few minutes compared to days/hours.</p>

<p><a name="references"></a></p>

<h2>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References</h2>

<p>
RapidPT is based on the paper, Speeding up Permutation Testing in Neuroimaging, presented at NIPS, 2013.</p>

<p>C. Hinrichs, V. K. Ithapu, Q. Sun, V. Singh, S. C. Johnson, Speeding up Permutation Testing in Neuroimaging, Neural Information Processing Systems (NIPS), 2013.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/felipegb94/RapidPT">Rapidpt</a> is maintained by <a href="https://github.com/felipegb94">felipegb94</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
